<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- ã‚ºãƒ¼ãƒ ç¦æ­¢ï¼ˆLINEå†…WebView/iOSå¯¾ç­–ï¼‰ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <title>å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    :root {
      --bg: #f7f8f9;
      --panel: #ffffff;
      --border: #e0e4ea;
      --text: #222;
      --sub: #666;
      --accent: #06C755;
      --accent-light: #d6f5dd;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: "Hiragino Sans", "Noto Sans JP", system-ui, sans-serif;
      color: var(--text);
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      text-align: center;
      color: #111;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .section h3,
    .section h4 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent);
      padding-left: 8px;
      color: #111;
    }

    label {
      font-weight: 600;
      font-size: 14px;
      color: #222;
    }

    .req { color: #e54848; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="url"],
    input[type="datetime-local"],
    textarea,
    select,
    input[type="tel"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: #222;
      font-size: 16px; /* iOSãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è‡ªå‹•ã‚ºãƒ¼ãƒ å›é¿ */
      box-sizing: border-box;
    }

    textarea { min-height: 100px; resize: vertical; }

    .mini {
      font-size: 12.5px;
      color: var(--sub);
      line-height: 1.5;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    button {
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      padding: 14px;
      cursor: pointer;
      border: none;
      transition: .2s ease;
    }

    button.primary { background: var(--accent); color: #fff; }
    button.primary:hover { background: #05b54e; }
    button[disabled] { opacity: .6; cursor: not-allowed; }

    /* ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ */
    .stepper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stepper button {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f4f6f9;
      font-size: 22px;
      line-height: 1;
      padding: 0;
    }
    .stepper input {
      text-align: center;
      width: 72px;
    }

    /* ã‚«ãƒ¼ãƒ‰UI / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•ï¼‰ */
    .sample-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .sample-card {
      width: 200px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border: 1px solid #e0e0e0;
      font-size: 13px;
    }
    .sample-card img { width: 100%; height: 120px; object-fit: cover; }
    .sample-card .sample-body { padding: 8px 10px 12px; }
    .sample-card .title { font-weight: 600; margin: 4px 0; color: #222; }
    .sample-card .desc { color: #555; font-size: 12px; line-height: 1.4; }
    .sample-card .tag {
      background: #555; color: #fff; font-size: 11px; border-radius: 6px;
      padding: 2px 6px; display: inline-block;
    }
    .sample-card .buttons { border-top: 1px solid #eee; }
    .sample-card .btn { text-align: center; color: #06c755; padding: 6px; font-weight: 600; cursor: pointer; }
    .sample-card .price { text-align: right; color: #222; font-weight: 600; }

    .coupon-card-container { display: flex; flex-direction: column; gap: 12px; margin-top: 14px; }
    .coupon-card {
      border: 1px solid var(--border); background: #fff; border-radius: 10px;
      padding: 16px 18px; box-shadow: 0 2px 6px rgba(0, 0, 0, .05); cursor: pointer; transition: .2s;
    }
    .coupon-card.active { border-color: var(--accent); background: var(--accent-light); box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2); }
    .coupon-settings {
      background: #fff; border-radius: 12px; padding: 18px 16px 22px; border: 1px solid var(--border);
      margin-top: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }
    .coupon-settings .grid { display: flex; flex-direction: column; gap: 14px; }
    .coupon-settings input, .coupon-settings textarea, .coupon-settings select {
      font-size: 16px; padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border); background: #fdfdfd;
    }

    .grid { display: flex; flex-direction: column; gap: 10px; }
    @media (min-width:720px) {
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    }

    .card {
      background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05); margin-bottom: 10px;
    }

    /* ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .rm-map { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; margin: 12px 0; }
    .rm-map img {
      display: block; width: 100%; max-width: 320px; height: auto;
      border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      object-fit: contain; pointer-events: none;
    }
    .rm-hot { position: absolute; cursor: pointer; background: transparent; transition: background .2s; z-index: 10; }
    .rm-hot.active { background: rgba(6,199,85,0.25); border-radius: 4px; }

    .legend { display: flex; flex-wrap: wrap; gap: 6px 12px; font-size: 12px; color: var(--sub); margin-top: 8px; }
    .legend .key::before { content: "â–  "; color: var(--accent); }

    .local-actions {
      position: sticky; bottom: -8px; background: #fff; padding: 12px 0 4px;
      border-top: 1px solid var(--border); display: flex; gap: 10px; z-index: 5;
    }
    .local-actions .tip { margin-left: auto; font-size: 12px; color: var(--sub); align-self: center; }

    /* sec-card å†…è£…é£¾ */
    #sec-card .card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 18px 16px 20px; box-shadow: 0 2px 5px rgba(0,0,0,.05); margin-bottom: 18px; }
    #sec-card .subfields, #sec-card .two {
      background: #f9fafb; border-radius: 8px; padding: 10px 12px 12px; margin-top: 10px; border: 1px solid #e9edf3;
    }
    #sec-card input[type="file"] { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    #sec-card .two { display: flex; flex-direction: column; gap: 12px; }
    @media (min-width:720px) { #sec-card .two { flex-direction: row; } }

    /* ã‚«ãƒ©ãƒ¼è¦‹æœ¬ */
    .color-samples {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px;
    }
    .color-box {
      border: 2px solid var(--border, #ddd); border-radius: 8px; padding: 8px; font-size: 12px; text-align: center;
      background: var(--c); color: #fff; cursor: pointer; transition: all 0.2s ease;
    }
    .color-box span { display: block; font-size: 10px; opacity: 0.8; }
    .color-box.selected { border: 2px solid #06c755; box-shadow: 0 0 0 2px rgba(6,199,85,0.3); transform: scale(1.05); }
    .color-box[data-color="#ffffff"] { border: 1px solid #ccc; color: #333; }

    /* é€ä¿¡ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.active { display: flex; }
    .loading-box {
      display: flex; align-items: center; gap: 12px;
      background: #fff; padding: 14px 16px; border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.1); border: 1px solid var(--border);
      font-weight: 600; color: #333;
    }
    .spinner {
      width: 22px; height: 22px; border-radius: 50%;
      border: 3px solid #e6eaf0; border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="container" id="appRoot">
    <div class="kicker">
      <h1>å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </h1>
    </div>

    <!-- â‘  åŸºæœ¬æƒ…å ± -->
    <div class="section">
      <h3>â‘  åŸºæœ¬æƒ…å ±</h3>
      <div class="grid">
        <div class="field">
          <label>åº—èˆ—å / ä¼æ¥­å<span class="req">*</span></label>
          <input id="storeName" type="text" placeholder="ä¾‹ï¼‰ã€‡ã€‡ã‚µãƒ­ãƒ³" required>
          <div class="mini">â€»ä¸€åº¦å…¥åŠ›ã™ã‚‹ã¨æ¬¡å›ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
        </div>
        <div class="field">
          <label>å¤§å…ƒã‚«ãƒ†ã‚´ãƒª<span class="req">*</span></label>
          <select id="requestType" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="card">ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
            <option value="richmenu">ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ6ãƒœã‚¿ãƒ³ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ï¼‰</option>
            <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
            <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
            <option value="other">ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</option>
          </select>
          <div class="mini">â€»é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã®ã¿ä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>

    <!-- â‘¡ ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="sec-card" class="section" style="display:none">
      <h3>â‘¡ ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</h3>

      <!-- å…¥åŠ›ã«å¿œã˜ãŸè¦‹ãŸç›®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•ï¼‰ -->
      <div id="cardSampleWrap" style="margin-top:20px; display:none;">
        <h4>ã‚«ãƒ¼ãƒ‰è¦‹ãŸç›®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
        <div id="cardSampleContainer" class="sample-container"></div>
      </div>

      <div class="row" style="align-items:center; margin-bottom:10px">
        <div class="field" style="max-width:280px">
          <label>ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ï¼ˆå…¨ã‚«ãƒ¼ãƒ‰ã®åˆæœŸå€¤ï¼‰<span class="req">*</span></label>
          <select id="cardGlobalType">
            <option value="image" selected>ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå†™çœŸï¼‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>
            <option value="product">ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼ˆå•†å“ï¼‰</option>
            <option value="location">ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåº—èˆ—ãƒ»ä¼šå ´ï¼‰</option>
            <option value="person">ãƒ‘ãƒ¼ã‚½ãƒ³ï¼ˆäººç‰©ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div class="field" style="max-width:260px">
          <label>ä½œæˆæšæ•°ï¼ˆ1ã€œ9ï¼‰<span class="req">*</span></label>
          <div class="stepper">
            <button type="button" id="ccDec" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
            <input
              id="cardCount"
              type="tel"
              inputmode="numeric"
              pattern="[0-9]*"
              maxlength="1"
              value="1"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false">
            <button type="button" id="ccInc" aria-label="å¢—ã‚„ã™">ï¼‹</button>
          </div>
          <div class="mini">å¤‰æ›´ã™ã‚‹ã¨ä¸‹ã®ã‚«ãƒ¼ãƒ‰UIã‚’å†æç”»ã—ã¾ã™</div>
        </div>
        <div class="mini">å„ã‚«ãƒ¼ãƒ‰ã¯<b>ç”»åƒ1æšå¿…é ˆ</b>ï¼ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰ï¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆä»»æ„ï¼‰ã‚’è¨­å®šã§ãã¾ã™</div>
      </div>

      <div id="cardsWrap" class="row" style="margin-top:8px; gap:14px; flex-direction:column"></div>
    </div>

    <!-- â‘¢ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="sec-richmenu" class="section" style="display:none">
      <h3>â‘¢ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div class="field" style="margin-bottom:12px">
        <label>ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é…ç½®å›³ï¼ˆã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§è©²å½“ãƒœã‚¿ãƒ³ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰</label>
        <div class="rm-map" id="rmMapWrap">
          <img id="rmMapImg"
            src="https://www.dropbox.com/scl/fi/ob83wfx3fuy08m1f67vt3/1.jpg?rlkey=72kytf83rd7bhq1l09nds6gc3&st=njv25e3r&dl=1"
            alt="ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼é…ç½®å›³ Aã€œFï¼ˆ3x2ï¼‰">
        </div>
        <div class="legend">
          <span class="key">A â†’ ãƒœã‚¿ãƒ³1</span><span class="key">B â†’ ãƒœã‚¿ãƒ³2</span><span class="key">C â†’ ãƒœã‚¿ãƒ³3</span>
          <span class="key">D â†’ ãƒœã‚¿ãƒ³4</span><span class="key">E â†’ ãƒœã‚¿ãƒ³5</span><span class="key">F â†’ ãƒœã‚¿ãƒ³6</span>
        </div>
      </div>

      <div class="mini" style="margin:6px 0 10px">å„ãƒœã‚¿ãƒ³ã¯ã€Œãƒœã‚¿ãƒ³åã€ã¨ã€Œé·ç§»å…ˆã€ã®ä¸¡æ–¹ã‚’å…¥ã‚Œã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼ˆç‰‡æ–¹ã®ã¿å…¥åŠ›ã¯ã‚¨ãƒ©ãƒ¼ï¼‰ã€‚</div>

      <div id="rmButtons" class="row" style="flex-direction:column; gap:12px">
        <!-- 1ã€œ6 -->
        <div class="card" id="rmBtn1">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³1</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn1Label" maxlength="15" type="text" placeholder="ä¾‹ï¼‰äºˆç´„ã™ã‚‹"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn1Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn1Value" type="text" placeholder="https:// ã¾ãŸã¯ åç§°/ãƒ†ã‚­ã‚¹ãƒˆ"></div>
        </div>

        <div class="card" id="rmBtn2">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³2</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn2Label" maxlength="15" type="text"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn2Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn2Value" type="text"></div>
        </div>

        <div class="card" id="rmBtn3">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³3</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn3Label" maxlength="15" type="text"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn3Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn3Value" type="text"></div>
        </div>

        <div class="card" id="rmBtn4">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³4</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn4Label" maxlength="15" type="text"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn4Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn4Value" type="text"></div>
        </div>

        <div class="card" id="rmBtn5">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³5</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn5Label" maxlength="15" type="text"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn5Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn5Value" type="text"></div>
        </div>

        <div class="card" id="rmBtn6">
          <div class="mini" style="margin-bottom:6px">ãƒœã‚¿ãƒ³6</div>
          <div class="two">
            <div class="field"><label>ãƒœã‚¿ãƒ³åï¼ˆ15æ–‡å­—ï¼‰</label><input id="rmBtn6Label" maxlength="15" type="text"></div>
            <div class="field">
              <label>é·ç§»å…ˆã‚¿ã‚¤ãƒ—</label>
              <select id="rmBtn6Type">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="link">URL</option>
                <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                <option value="shopcard">ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</option>
                <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
              </select>
            </div>
          </div>
          <div class="field"><label>é·ç§»å…ˆå†…å®¹</label><input id="rmBtn6Value" type="text"></div>
        </div>
      </div>
    </div>

    <!-- â‘£ ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ -->
    <div id="sec-shopcard" class="section" style="display:none">
      <h3>â‘£ ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰</h3>

      <div class="grid">
        <div class="field"><label>ã‚«ãƒ¼ãƒ‰å</label><input id="scName" type="text"></div>
        <div class="field">
          <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼<span class="req">*</span></label>
          <input id="scColor" type="hidden" value="#5a5aff">
          <div class="color-samples" id="colorSamples">
            <div class="color-box" data-color="#ff3b30" style="--c:#ff3b30">RED<br><span>#ff3b30</span></div>
            <div class="color-box" data-color="#ff9500" style="--c:#ff9500">ORANGE<br><span>#ff9500</span></div>
            <div class="color-box" data-color="#ffcc00" style="--c:#ffcc00">YELLOW<br><span>#ffcc00</span></div>
            <div class="color-box" data-color="#34c759" style="--c:#34c759">GREEN<br><span>#34c759</span></div>
            <div class="color-box" data-color="#5a5aff" style="--c:#5a5aff">BLUE<br><span>#5a5aff</span></div>
            <div class="color-box" data-color="#af52de" style="--c:#af52de">PURPLE<br><span>#af52de</span></div>
            <div class="color-box" data-color="#ff2d55" style="--c:#ff2d55">PINK<br><span>#ff2d55</span></div>
            <div class="color-box" data-color="#6b4a3b" style="--c:#6b4a3b">BROWN<br><span>#6b4a3b</span></div>
            <div class="color-box" data-color="#8e8e93" style="--c:#8e8e93">GRAY<br><span>#8e8e93</span></div>
            <div class="color-box" data-color="#000000" style="--c:#000000">BLACK<br><span>#000000</span></div>
            <div class="color-box" data-color="#ffffff" style="--c:#ffffff; color:#333;">WHITE<br><span>#ffffff</span></div>
          </div>
        </div>
      </div>
      <div class="mini">ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</div>

      <div class="field"><label>ã‚´ãƒ¼ãƒ«ã¾ã§ã®ãƒã‚¤ãƒ³ãƒˆæ•°</label><input id="scGoalPoints" type="number" min="1" max="100" value="10"></div>
      <div class="field"><label>ã‚´ãƒ¼ãƒ«ç‰¹å…¸å</label><input id="scGoalReward" type="text"></div>
      <div class="field"><label>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</label><input id="scCheckpoint" type="text"></div>
      <div class="field"><label>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç‰¹å…¸</label><input id="scCheckpointReward" type="text"></div>

      <div class="section" style="margin-top:18px">
        <h4>ãƒã‚¤ãƒ³ãƒˆå–å¾—åˆ¶é™</h4>
        <div class="field">
          <label><input type="radio" name="scLimit" value="sameDay" checked> åŒæ—¥ä¸­ã®é‡è¤‡ä»˜ä¸ã‚’ç¦æ­¢ï¼ˆ0:00ã«ãƒªã‚»ãƒƒãƒˆï¼‰</label><br>
          <label><input type="radio" name="scLimit" value="hours"> æŒ‡å®šæ™‚é–“å†…ã®é‡è¤‡ä»˜ä¸ã‚’ç¦æ­¢ï¼š</label>
          <select id="scLimitHours" style="margin-left:8px;">
            <option value="1">1æ™‚é–“</option>
            <option value="3">3æ™‚é–“</option>
            <option value="6">6æ™‚é–“</option>
            <option value="12">12æ™‚é–“</option>
          </select><br>
          <label><input type="radio" name="scLimit" value="none"> åˆ¶é™ã—ãªã„</label>
        </div>
      </div>

      <div class="field" style="margin-top:16px;">
        <label>åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</label>
        <textarea id="scGuide" placeholder="- æ¥åº—1å›ã”ã¨ã«1ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã•ã‚Œã¾ã™ã€‚"></textarea>
      </div>

      <div class="section" style="margin-top:18px">
        <h4>ã‚«ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™</h4>
        <div class="field">
          <div class="expire-options">
            <label><input type="radio" name="scExpireType" value="lastUse" checked> æœ€çµ‚åˆ©ç”¨æ—¥ã‹ã‚‰</label>
            <input id="scExpireLastYear" type="number" min="0" value="1"> å¹´
            <input id="scExpireLastMonth" type="number" min="0" value="0"> ãƒ¶æœˆ
          </div>
          <div class="expire-options">
            <label><input type="radio" name="scExpireType" value="firstUse"> åˆå›åˆ©ç”¨æ—¥ã‹ã‚‰</label>
            <input id="scExpireFirstYear" type="number" min="0" value="1"> å¹´
            <input id="scExpireFirstMonth" type="number" min="0" value="0"> ãƒ¶æœˆ
          </div>
          <div class="expire-options">
            <label><input type="radio" name="scExpireType" value="none"> è¨­å®šã—ãªã„</label>
          </div>
        </div>

        <div class="section" style="margin-top:18px">
          <h4>æœ‰åŠ¹æœŸé™ã®é€šçŸ¥</h4>
          <div class="field">
            <label><input type="radio" name="scNotice" value="1day" checked> å‰æ—¥</label><br>
            <label><input type="radio" name="scNotice" value="3days"> 3æ—¥å‰</label><br>
            <label><input type="radio" name="scNotice" value="1week"> 1é€±é–“å‰</label><br>
            <label><input type="radio" name="scNotice" value="none"> é€šçŸ¥ã—ãªã„</label>
          </div>
        </div>

        <div class="field" style="margin-top:16px;">
          <label>ã‚«ãƒ¼ãƒ‰å–å¾—ãƒœãƒ¼ãƒŠã‚¹</label>
          <input id="scBonus" type="number" min="0" value="0"> ãƒã‚¤ãƒ³ãƒˆ
        </div>

        <div class="field" style="margin-top:16px;">
          <label>ã‚«ãƒ¼ãƒ‰ç”»åƒï¼ˆä»»æ„ï¼‰</label><input id="scImage" type="file" accept="image/*">
        </div>
      </div>
    </div>

    <!-- â‘¤ ã‚¯ãƒ¼ãƒãƒ³ -->
    <div id="sec-coupon" class="section" style="display:none">
      <h3>â‘¤ ã‚¯ãƒ¼ãƒãƒ³</h3>
      <div class="section" style="margin-top:18px">
        <h4>ã‚¯ãƒ¼ãƒãƒ³ç²å¾—æ¡ä»¶</h4>
        <div class="coupon-card-container">
          <div class="coupon-card active" data-type="none">
            <h5>ğŸ æ¡ä»¶ãªã—</h5>
            <p>ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç²å¾—å¯èƒ½</p>
          </div>
          <div class="coupon-card" data-type="lottery">
            <h5>ğŸ¯ æŠ½é¸</h5>
            <p>å½“é¸è€…ã®ã¿ç²å¾—å¯èƒ½</p>
          </div>
          <div class="coupon-card" data-type="referral">
            <h5>ğŸ¤ å‹ã ã¡ç´¹ä»‹</h5>
            <p>ç´¹ä»‹ã—ãŸäººãƒ»ã•ã‚ŒãŸäººãŒå¯¾è±¡</p>
          </div>
        </div>

        <input type="hidden" id="cpAcquireType" value="none">

        <!-- æ¡ä»¶ãªã— -->
        <div id="cp-none-settings" class="coupon-settings" style="display:block;">
          <div class="grid">
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³åï¼ˆ60æ–‡å­—ï¼‰</label><input id="cpNoneName" maxlength="60" type="text"></div>
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³å†…å®¹</label><input id="cpNoneContent" type="text" placeholder="ä¾‹ï¼š500å††å¼•ãï¼â—‹â—‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆãªã©"></div>
            <div class="field"><label>æœ‰åŠ¹æœŸé–“</label><input id="cpNoneStart" type="datetime-local"> ï½ <input id="cpNoneEnd" type="datetime-local"></div>
            <div class="field"><label>åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</label><textarea id="cpNoneGuide">- ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã“ã®ç”»é¢ã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«æç¤ºã—ã¦ãã ã•ã„ã€‚</textarea></div>
            <div class="field"><label>ä½¿ç”¨ç”¨é€”</label><input id="cpNoneUse" type="text"></div>
            <div class="field">
              <label>ä½¿ç”¨å¯èƒ½å›æ•°</label>
              <select id="cpNoneLimit">
                <option value="once">1å›ã®ã¿</option>
                <option value="unlimited">ä¸Šé™ãªã—</option>
              </select>
            </div>
            <div class="field"><label>ï¼ˆä»»æ„ï¼‰åˆ©ç”¨æ¡ä»¶</label><input id="cpNoneCondition" type="text"></div>
          </div>
        </div>

        <!-- æŠ½é¸ -->
        <div id="cp-lottery-settings" class="coupon-settings" style="display:none;">
          <div class="grid">
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³åï¼ˆ60æ–‡å­—ï¼‰</label><input id="cpLotteryName" maxlength="60" type="text"></div>
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³å†…å®¹</label><input id="cpLotteryContent" type="text"></div>
            <div class="field"><label>æœ‰åŠ¹æœŸé–“</label><input id="cpLotteryStart" type="datetime-local"> ï½ <input id="cpLotteryEnd" type="datetime-local"></div>
            <div class="field"><label>åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</label><textarea id="cpLotteryGuide">- ã‚¯ãƒ¼ãƒãƒ³æç¤ºã§ã”åˆ©ç”¨ãã ã•ã„ã€‚</textarea></div>
            <div class="field"><label>å½“é¸ç¢ºç‡ï¼ˆ1ï½99%ï¼‰</label><input id="cpLotteryRate" type="number" min="1" max="99" value="50"></div>
            <div class="field"><label>å½“é¸è€…æ•°ã®ä¸Šé™</label><input id="cpLotteryMax" type="number" min="1" placeholder="ä¾‹ï¼š100"></div>
            <div class="field"><label>ä½¿ç”¨ç”¨é€”</label><input id="cpLotteryUse" type="text"></div>
            <div class="field">
              <label>ä½¿ç”¨å¯èƒ½å›æ•°</label>
              <select id="cpLotteryLimit">
                <option value="once">1å›ã®ã¿</option>
                <option value="unlimited">ä¸Šé™ãªã—</option>
              </select>
            </div>
            <div class="field"><label>ï¼ˆä»»æ„ï¼‰åˆ©ç”¨æ¡ä»¶</label><input id="cpLotteryCondition" type="text"></div>
          </div>
        </div>

        <!-- å‹ã ã¡ç´¹ä»‹ -->
        <div id="cp-referral-settings" class="coupon-settings" style="display:none;">
          <div class="grid">
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³åï¼ˆ60æ–‡å­—ï¼‰</label><input id="cpReferralName" maxlength="60" type="text"></div>
            <div class="field"><label>ç´¹ä»‹æœŸé–“</label><input id="cpReferralStart" type="datetime-local"> ï½ <input id="cpReferralEnd" type="datetime-local"></div>
            <div class="field"><label>æ³¨æ„äº‹é …</label><textarea id="cpReferralNote">- äºˆå‘Šãªãå¤‰æ›´ã¾ãŸã¯çµ‚äº†ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</textarea></div>
            <div class="field">
              <label>ã‚¯ãƒ¼ãƒãƒ³ç²å¾—æ—¥ã‹ã‚‰ã®æœ‰åŠ¹æœŸé–“</label>
              <select id="cpReferralValidType">
                <option value="7">7æ—¥é–“</option>
                <option value="30">30æ—¥é–“</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ è¨­å®š</option>
              </select>
              <input id="cpReferralCustomDays" type="number" min="1" max="180" placeholder="1ï½180æ—¥é–“" style="display:none;margin-top:6px;">
            </div>
            <div class="field"><label>ã‚¯ãƒ¼ãƒãƒ³å†…å®¹</label><input id="cpReferralContent" type="text"></div>
            <div class="field"><label>åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</label><textarea id="cpReferralGuide">- ã‚¯ãƒ¼ãƒãƒ³æç¤ºã§ã”åˆ©ç”¨ãã ã•ã„ã€‚</textarea></div>
            <div class="field"><label>ä½¿ç”¨ç”¨é€”</label><input id="cpReferralUse" type="text"></div>
            <div class="field">
              <label>ç²å¾—å¯èƒ½å›æ•°</label>
              <select id="cpReferralCountType">
                <option value="unlimited">ä¸Šé™ãªã—</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ è¨­å®š</option>
              </select>
              <input id="cpReferralCountCustom" type="number" min="1" max="30" placeholder="1ï½30å›" style="display:none;margin-top:6px;">
            </div>
            <div class="field"><label>ï¼ˆä»»æ„ï¼‰åˆ©ç”¨æ¡ä»¶</label><input id="cpReferralCondition" type="text"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â‘¥ ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰ -->
    <div id="sec-other" class="section" style="display:none">
      <h3>â‘¥ ãã®ä»–</h3>
      <div class="field">
        <label>è‡ªç”±è¨˜è¿°</label>
        <textarea id="otherText" placeholder="ã”å¸Œæœ›ã‚„è£œè¶³äº‹é …ã‚’è‡ªç”±ã«ãŠæ›¸ããã ã•ã„"></textarea>
      </div>
      <div class="field">
        <label>ç”»åƒï¼ˆä»»æ„ãƒ»è¤‡æ•°å¯ï¼‰</label>
        <input id="otherImages" type="file" multiple accept="image/*">
      </div>
      <div class="buttons">
        <button class="primary" type="button" id="btnSubmitOther">ã“ã®è‡ªç”±è¨˜è¿°ã‚’é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- é€ä¿¡ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true" role="alert" aria-live="assertive">
    <div class="loading-box">
      <div class="spinner" aria-hidden="true"></div>
      <div>é€ä¿¡ä¸­â€¦</div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    // ===== ã‚ºãƒ¼ãƒ æ“ä½œã®æŠ‘æ­¢ï¼ˆiOS/LINEå†…WebViewï¼‰ =====
    document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive: false });
    document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });

    const GAS_URL = "https://script.google.com/macros/s/AKfycbwGCUTvZgXf4PhnnTnwDWdB_p-3lZ0obhSs7ZHts3fiK6OcTo3CziM6F26Th7535IGxiw/exec";
    const $ = s => document.querySelector(s);
    const on = (el, evt, fn) => el && el.addEventListener(evt, fn);
    const show = (el, v = true) => el.style.display = v ? '' : 'none';

    // === LINEé€£æºï¼ˆLIFFï¼‰ ===
    const LIFF_ID = '2006164734-B8ynaQK5';
    let liffReady = false;
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
      } catch (e) {
        // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç›´é–‹ãæ™‚ãªã©ã¯å¤±æ•—ã—ã¦OK
      }
    });

    async function trySendToLINE(text) {
      try {
        if (!liffReady) return false;
        if (!liff.isInClient()) return false; // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç›´é–‹ãã¯ã‚¹ã‚­ãƒƒãƒ—
        await liff.sendMessages([{ type: 'text', text }]);
        return true;
      } catch (e) {
        return false;
      }
    }

    // ====== åº—èˆ—åã®è‡ªå‹•ä¿å­˜ãƒ»è‡ªå‹•å…¥åŠ› ======
    const STORE_NAME_KEY = 'liff_form.storeName';
    // åˆæœŸèª­è¾¼
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem(STORE_NAME_KEY);
      if (saved) {
        const input = $('#storeName');
        if (input && !input.value) input.value = saved;
      }
    });
    // å…¥åŠ›ã®ãŸã³ã«ä¿å­˜
    on($('#storeName'), 'input', (e) => {
      localStorage.setItem(STORE_NAME_KEY, (e.target.value || '').trim());
    });
    // é€ä¿¡æˆåŠŸæ™‚ã«ã‚‚å¿µã®ãŸã‚ä¿å­˜
    function persistStoreName() {
      const val = ($('#storeName')?.value || '').trim();
      if (val) localStorage.setItem(STORE_NAME_KEY, val);
    }

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
    const sections = {
      card: $('#sec-card'),
      richmenu: $('#sec-richmenu'),
      shopcard: $('#sec-shopcard'),
      coupon: $('#sec-coupon'),
      other: $('#sec-other')
    };

    on($('#requestType'), 'change', () => {
      Object.values(sections).forEach(s => show(s, false));
      const v = $('#requestType').value;
      if (!v) return;
      show(sections[v], true);
      if (v === 'card') renderCards();

      // ã‚¯ãƒ¼ãƒãƒ³åˆæœŸè¡¨ç¤ºã‚’å¸¸ã«ã€Œæ¡ä»¶ãªã—ã€ã«æˆ»ã™
      if (v === 'coupon') {
        document.querySelectorAll('.coupon-card').forEach(c => c.classList.remove('active'));
        const none = document.querySelector('.coupon-card[data-type="none"]');
        none?.classList.add('active');
        $('#cpAcquireType').value = 'none';
        document.querySelectorAll('.coupon-settings').forEach(s => s.style.display = 'none');
        $('#cp-none-settings').style.display = 'block';
      }

      ensureLocalActions(sections[v]); // è¡¨ç¤ºä¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã«è¨­ç½®
    });

    // æ•°å­—åŠè§’åŒ–
    function toHalfWidthDigits(s) {
      return (s || '').replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    }

    // ã‚«ãƒ¼ãƒ‰æšæ•°ï¼ˆ1..9ã«è£œæ­£ï¼‰
    function getCardCountSafe() {
      const el = $('#cardCount');
      let raw = toHalfWidthDigits((el.value || '').trim()).replace(/\D/g, '');
      let n = raw ? parseInt(raw, 10) : 1;
      if (!Number.isFinite(n)) n = 1;
      if (n < 1) n = 1;
      if (n > 9) n = 9;
      el.value = String(n);
      return n;
    }

    // ---- ã‚«ãƒ¼ãƒ‰UIç”Ÿæˆ ----
    function renderCards() {
      const wrap = $('#cardsWrap');
      const n = getCardCountSafe();
      wrap.innerHTML = '';
      const globalType = ($('#cardGlobalType')?.value || 'image');

      const buildSubfields = (t) => {
        if (t === 'product') {
          return `
            <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap">
              <div class="field" style="min-width:240px;">
                <label>ç”»åƒï¼ˆå¿…é ˆãƒ»1æšã¾ã§ï¼‰<span class="req">*</span></label>
                <input type="file" class="cd-image" accept="image/*" required>
              </div>
              <div class="field" style="min-width:200px; flex:1">
                <label>ã‚¿ã‚°ï¼ˆä»»æ„ãƒ»æœ€å¤§12æ–‡å­—ï¼‰</label>
                <input type="text" class="pd-tag" maxlength="12" placeholder="ä¾‹ï¼‰æ–°ç€ / äººæ°—">
              </div>
            </div>

            <div class="subfields active">
              <div class="grid">
                <div class="field">
                  <label>ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20æ–‡å­—å¿…é ˆï¼‰<span class="req">*</span></label>
                  <input type="text" class="pd-title" maxlength="20" placeholder="ä¾‹ï¼‰ãŠã¾ã‹ã›ã‚³ãƒ¼ã‚¹60åˆ†" required>
                </div>
                <div class="field">
                  <label>ä¾¡æ ¼ï¼ˆ15æ–‡å­—ãƒ»å††/\\ å¯ï¼‰</label>
                  <input type="text" class="pd-priceText" maxlength="15" placeholder="ä¾‹ï¼‰5,980å†† / \\5980">
                </div>
                <div class="field" style="grid-column:1/-1">
                  <label>èª¬æ˜æ–‡ï¼ˆ60æ–‡å­—ä»»æ„ï¼‰</label>
                  <textarea class="pd-desc" maxlength="60" placeholder="ä¾‹ï¼‰çŠ¶æ…‹ã«åˆã‚ã›ã¦æœ€é©ã«æ–½è¡“ã—ã¾ã™ã€‚"></textarea>
                </div>
              </div>
            </div>
          `;
        }
        if (t === 'location') {
          return `
            <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap">
              <div class="field" style="min-width:240px;">
                <label>ç”»åƒï¼ˆå¿…é ˆãƒ»1æšã¾ã§ï¼‰<span class="req">*</span></label>
                <input type="file" class="cd-image" accept="image/*" required>
              </div>
              <div class="field" style="min-width:200px; flex:1">
                <label>ã‚¿ã‚°ï¼ˆä»»æ„ãƒ»æœ€å¤§12æ–‡å­—ï¼‰</label>
                <input type="text" class="lc-tag" maxlength="12" placeholder="ä¾‹ï¼‰æœ¬åº— / æ–°è£…é–‹åº—">
              </div>
            </div>

            <div class="subfields active">
              <div class="grid">
                <div class="field">
                  <label>ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20æ–‡å­—å¿…é ˆï¼‰<span class="req">*</span></label>
                  <input type="text" class="lc-title" maxlength="20" placeholder="ä¾‹ï¼‰åº—èˆ—åãªã©" required>
                </div>
                <div class="field" style="grid-column:1/-1">
                  <label>ä½æ‰€ï¼ˆ60æ–‡å­—ä»»æ„ï¼‰</label>
                  <input type="text" class="lc-address" maxlength="60">
                </div>
                <div class="field">
                  <label>æ™‚é–“ï¼ˆ30æ–‡å­— ä»»æ„ï¼‰</label>
                  <input type="text" class="lc-hours" maxlength="30">
                </div>
                <div class="field">
                  <label>ä¾¡æ ¼ï¼ˆ15æ–‡å­— ä»»æ„ãƒ»å††/\\ å¯ï¼‰</label>
                  <input type="text" class="lc-priceText" maxlength="15">
                </div>
              </div>
              <div class="mini">â€»ã€Œæ™‚é–“ã€ã¾ãŸã¯ã€Œä¾¡æ ¼ã€ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã§ã‚‚OK</div>
            </div>
          `;
        }
        if (t === 'person') {
          return `
            <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap">
              <div class="field" style="min-width:240px;">
                <label>ç”»åƒï¼ˆå¿…é ˆãƒ»1æšã¾ã§ï¼‰<span class="req">*</span></label>
                <input type="file" class="cd-image" accept="image/*" required>
              </div>
            </div>

            <div class="subfields active">
              <div class="grid">
                <div class="field">
                  <label>åå‰ï¼ˆ20æ–‡å­—å¿…é ˆï¼‰<span class="req">*</span></label>
                  <input type="text" class="ps-name" maxlength="20" required>
                </div>
                <div class="field"><label>ã‚¿ã‚°1ï¼ˆä»»æ„ï¼‰</label><input type="text" class="ps-tag1" maxlength="12"></div>
                <div class="field"><label>ã‚¿ã‚°2ï¼ˆä»»æ„ï¼‰</label><input type="text" class="ps-tag2" maxlength="12"></div>
                <div class="field"><label>ã‚¿ã‚°3ï¼ˆä»»æ„ï¼‰</label><input type="text" class="ps-tag3" maxlength="12"></div>
                <div class="field" style="grid-column:1/-1">
                  <label>èª¬æ˜æ–‡ï¼ˆ60æ–‡å­—ä»»æ„ï¼‰</label>
                  <textarea class="ps-desc" maxlength="60"></textarea>
                </div>
              </div>
            </div>
          `;
        }
        return `
          <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap">
            <div class="field" style="min-width:240px;">
              <label>ç”»åƒï¼ˆå¿…é ˆãƒ»1æšã¾ã§ï¼‰<span class="req">*</span></label>
              <input type="file" class="cd-image" accept="image/*" required>
            </div>
            <div class="field" style="min-width:200px; flex:1">
              <label>ã‚¿ã‚°ï¼ˆä»»æ„ãƒ»æœ€å¤§12æ–‡å­—ï¼‰</label>
              <input type="text" class="img-tag" maxlength="12" placeholder="ä¾‹ï¼‰æœŸé–“é™å®š">
            </div>
          </div>
        `;
      };

      const buildActions = (t) => {
        if (t === 'image') {
          return `
            <div class="two" style="margin-top:10px">
              <div class="field">
                <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³1ï¼ˆä»»æ„ãƒ»ãƒœã‚¿ãƒ³å15æ–‡å­—ï¼‰</label>
                <input type="text" class="btn1-label" maxlength="15" placeholder="ä¾‹ï¼‰äºˆç´„ã™ã‚‹ / è©³ç´°ã‚’è¦‹ã‚‹">
              </div>
              <div class="field">
                <label>é·ç§»å…ˆ1ï¼ˆURL / ã‚¯ãƒ¼ãƒãƒ³ / ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ / ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
                <input type="text" class="btn1-dest" placeholder="https:// ã¾ãŸã¯ åç§°/ãƒ†ã‚­ã‚¹ãƒˆ">
              </div>
            </div>
          `;
        }
        return `
          <div class="two" style="margin-top:10px">
            <div class="field">
              <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³1ï¼ˆä»»æ„ãƒ»ãƒœã‚¿ãƒ³å15æ–‡å­—ï¼‰</label>
              <input type="text" class="btn1-label" maxlength="15" placeholder="ä¾‹ï¼‰äºˆç´„ã™ã‚‹ / è©³ç´°ã‚’è¦‹ã‚‹">
            </div>
            <div class="field">
              <label>é·ç§»å…ˆ1ï¼ˆURL / ã‚¯ãƒ¼ãƒãƒ³ / ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ / ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
              <input type="text" class="btn1-dest" placeholder="https:// ã¾ãŸã¯ åç§°/ãƒ†ã‚­ã‚¹ãƒˆ">
            </div>
          </div>
          <div class="two" style="margin-top:10px">
            <div class="field">
              <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³2ï¼ˆä»»æ„ãƒ»ãƒœã‚¿ãƒ³å15æ–‡å­—ï¼‰</label>
              <input type="text" class="btn2-label" maxlength="15" placeholder="ä¾‹ï¼‰ç©ºå¸­ç¢ºèª / é›»è©±ã™ã‚‹">
            </div>
            <div class="field">
              <label>é·ç§»å…ˆ2ï¼ˆURL / ã‚¯ãƒ¼ãƒãƒ³ / ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ / ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
              <input type="text" class="btn2-dest" placeholder="https:// ã¾ãŸã¯ åç§°/ãƒ†ã‚­ã‚¹ãƒˆ">
            </div>
          </div>
        `;
      };

      for (let i = 0; i < n; i++) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.index = String(i);
        card.dataset.type = globalType;
        card.innerHTML = `${buildSubfields(globalType)}${buildActions(globalType)}`;
        wrap.appendChild(card);
      }

      setTimeout(updateCardPreview, 0);
    }

    // ===== ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼æ“ä½œ =====
    on($('#ccDec'), 'click', () => {
      const v = getCardCountSafe();
      if (v > 1) { $('#cardCount').value = String(v - 1); renderCards(); }
    });
    on($('#ccInc'), 'click', () => {
      const v = getCardCountSafe();
      if (v < 9) { $('#cardCount').value = String(v + 1); renderCards(); }
    });

    // å…¥åŠ›ä¸­ã¯å†æç”»ã—ãªã„ï¼ˆiOS/LINEã§ã®ã€Œ1ã«æˆ»ã‚‹ã€ç¾è±¡å›é¿ï¼‰
    on($('#cardCount'), 'input', () => { getCardCountSafe(); });
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚Œ/ç¢ºå®šæ™‚ã®ã¿å†æç”»
    on($('#cardCount'), 'change', () => { renderCards(); });
    on($('#cardCount'), 'blur',   () => { renderCards(); });
    // ãƒ›ã‚¤ãƒ¼ãƒ«å¢—æ¸›ã‚’ç„¡åŠ¹åŒ–
    on($('#cardCount'), 'wheel', (e) => { e.preventDefault(); e.target.blur(); });
    on($('#cardCount'), 'focus', (e) => e.target.select());

    // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—å¤‰æ›´ã§å†æç”»
    on($('#cardGlobalType'), 'change', renderCards);

    // Base64 æ·»ä»˜
    const appendFilesBase64 = async (fd, selector, namePrefix) => {
      const elems = Array.from(document.querySelectorAll(selector));
      let inputs = [];
      if (elems.length === 0) {
        const el = document.querySelector(selector);
        if (el) elems.push(el);
      }
      elems.forEach(el => {
        if (el.tagName === 'INPUT' && el.type === 'file') inputs.push(el);
        else inputs.push(...el.querySelectorAll('input[type="file"]'));
      });
      const readers = [];
      let idx = 0;
      inputs.forEach(input => {
        Array.from(input.files || []).forEach(file => {
          readers.push(new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => { fd.append('b64_' + namePrefix + '_' + (idx++), String(fr.result)); resolve(); };
            fr.onerror = reject;
            fr.readAsDataURL(file);
          }));
        });
      });
      await Promise.all(readers);
    };

    function collectData() {
      const base = {
        storeName: $('#storeName')?.value?.trim() || '',
        requestType: $('#requestType')?.value || '',
        createdAt: new Date().toISOString(),
      };

      const detail = {};

      // ---- â‘  ã‚«ãƒ¼ãƒ‰ ----
      if (base.requestType === 'card') {
        const cardType = ($('#cardGlobalType')?.value || 'image');
        const cards = [];
        const nodes = document.querySelectorAll('#cardsWrap .card');

        nodes.forEach((c, idx) => {
          let tag = '', meta = {};
          const hasImage = !!(c.querySelector('.cd-image')?.files?.length);

          if (cardType === 'product') {
            tag = (c.querySelector('.pd-tag')?.value || '').trim();
            meta = {
              title: (c.querySelector('.pd-title')?.value || '').trim(),
              desc: (c.querySelector('.pd-desc')?.value || '').trim(),
              priceText: (c.querySelector('.pd-priceText')?.value || '').trim(),
            };
          } else if (cardType === 'location') {
            tag = (c.querySelector('.lc-tag')?.value || '').trim();
            meta = {
              title: (c.querySelector('.lc-title')?.value || '').trim(),
              address: (c.querySelector('.lc-address')?.value || '').trim(),
              hours: (c.querySelector('.lc-hours')?.value || '').trim(),
              priceText: (c.querySelector('.lc-priceText')?.value || '').trim(),
            };
          } else if (cardType === 'person') {
            meta = {
              name: (c.querySelector('.ps-name')?.value || '').trim(),
              tags: [
                (c.querySelector('.ps-tag1')?.value || '').trim(),
                (c.querySelector('.ps-tag2')?.value || '').trim(),
                (c.querySelector('.ps-tag3')?.value || '').trim(),
              ].filter(Boolean),
              desc: (c.querySelector('.ps-desc')?.value || '').trim(),
            };
          } else {
            tag = (c.querySelector('.img-tag')?.value || '').trim();
            meta = {};
          }

          const actions = [];
          const b1 = {
            label: (c.querySelector('.btn1-label')?.value || '').trim(),
            dest: (c.querySelector('.btn1-dest')?.value || '').trim(),
          };
          if (cardType === 'image') {
            if (b1.label && b1.dest) actions.push({ label: b1.label, destination: b1.dest });
          } else {
            const b2 = {
              label: (c.querySelector('.btn2-label')?.value || '').trim(),
              dest: (c.querySelector('.btn2-dest')?.value || '').trim(),
            };
            if (b1.label && b1.dest) actions.push({ label: b1.label, destination: b1.dest });
            if (b2.label && b2.dest) actions.push({ label: b2.label, destination: b2.dest });
          }

          cards.push({
            index: idx + 1,
            type: cardType,
            image: 'attached_as_b64_cardImage_' + idx,
            hasImage,
            tag,
            meta,
            actions
          });
        });

        detail.cards = cards;
      }

      // ---- â‘¡ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ ----
      if (base.requestType === 'richmenu') {
        const buttons = [];
        for (let i = 1; i <= 6; i++) {
          const label = $(`#rmBtn${i}Label`)?.value?.trim() || '';
          const type = $(`#rmBtn${i}Type`)?.value || '';
          const value = $(`#rmBtn${i}Value`)?.value?.trim() || '';
          if (label || type || value) buttons.push({ index: i, label, type, value });
        }
        detail.richmenu = { buttons };
      }

      // ---- â‘¢ ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ ----
      if (base.requestType === 'shopcard') {
        const limit = document.querySelector('input[name="scLimit"]:checked')?.value || 'sameDay';
        const expireType = document.querySelector('input[name="scExpireType"]:checked')?.value || 'lastUse';
        const notice = document.querySelector('input[name="scNotice"]:checked')?.value || '1day';
        const scImagePresent = !!($('#scImage')?.files?.length);

        detail.shopcard = {
          name: $('#scName')?.value?.trim() || '',
          color: $('#scColor')?.value || '#5a5aff',
          goalPoints: parseInt($('#scGoalPoints')?.value || '10', 10),
          goalReward: $('#scGoalReward')?.value?.trim() || '',
          checkpoint: $('#scCheckpoint')?.value?.trim() || '',
          checkpointReward: $('#scCheckpointReward')?.value?.trim() || '',
          guide: $('#scGuide')?.value || '',
          bonus: parseInt($('#scBonus')?.value || '0', 10),
          limit: {
            mode: limit,
            hours: limit === 'hours' ? parseInt($('#scLimitHours')?.value || '1', 10) : null,
          },
          expire: {
            type: expireType,
            lastUse: (expireType === 'lastUse') ? {
              years: parseInt($('#scExpireLastYear')?.value || '1', 10),
              months: parseInt($('#scExpireLastMonth')?.value || '0', 10),
            } : null,
            firstUse: (expireType === 'firstUse') ? {
              years: parseInt($('#scExpireFirstYear')?.value || '1', 10),
              months: parseInt($('#scExpireFirstMonth')?.value || '0', 10),
            } : null,
          },
          notice,
          image: 'attached_as_b64_scImage_0',
          scImagePresent,
        };
      }

      // ---- â‘£ ã‚¯ãƒ¼ãƒãƒ³ ----
      if (base.requestType === 'coupon') {
        const t = $('#cpAcquireType')?.value || 'none';

        if (t === 'none') {
          detail.coupon = {
            type: t,
            name: $('#cpNoneName')?.value?.trim() || '',
            content: $('#cpNoneContent')?.value?.trim() || '',
            start: $('#cpNoneStart')?.value || '',
            end: $('#cpNoneEnd')?.value || '',
            guide: $('#cpNoneGuide')?.value || '',
            use: $('#cpNoneUse')?.value?.trim() || '',
            limit: $('#cpNoneLimit')?.value || 'once',
            condition: $('#cpNoneCondition')?.value?.trim() || '',
          };
        }

        if (t === 'lottery') {
          detail.coupon = {
            type: t,
            name: $('#cpLotteryName')?.value?.trim() || '',
            content: $('#cpLotteryContent')?.value?.trim() || '',
            start: $('#cpLotteryStart')?.value || '',
            end: $('#cpLotteryEnd')?.value || '',
            guide: $('#cpLotteryGuide')?.value || '',
            rate: parseInt($('#cpLotteryRate')?.value || '50', 10),
            maxWinners: parseInt($('#cpLotteryMax')?.value || '0', 10) || null,
            use: $('#cpLotteryUse')?.value?.trim() || '',
            limit: $('#cpLotteryLimit')?.value || 'once',
            condition: $('#cpLotteryCondition')?.value?.trim() || '',
          };
        }

        if (t === 'referral') {
          const validType = $('#cpReferralValidType')?.value || '7';
          const countType = $('#cpReferralCountType')?.value || 'unlimited';
          detail.coupon = {
            type: t,
            name: $('#cpReferralName')?.value?.trim() || '',
            period: {
              start: $('#cpReferralStart')?.value || '',
              end: $('#cpReferralEnd')?.value || '',
            },
            note: $('#cpReferralNote')?.value || '',
            valid: {
              type: validType,
              days: (validType === 'custom') ? parseInt($('#cpReferralCustomDays')?.value || '0', 10) : parseInt(validType, 10),
            },
            content: $('#cpReferralContent')?.value?.trim() || '',
            guide: $('#cpReferralGuide')?.value || '',
            use: $('#cpReferralUse')?.value?.trim() || '',
            acquireCount: {
              type: countType,
              value: (countType === 'custom') ? parseInt($('#cpReferralCountCustom')?.value || '0', 10) : null,
            },
            condition: $('#cpReferralCondition')?.value?.trim() || '',
          };
        }
      }

      // ---- â‘¤ ãã®ä»– ----
      if (base.requestType === 'other') {
        const files = Array.from($('#otherImages')?.files || []);
        detail.other = {
          text: ($('#otherText')?.value || '').trim(),
          imagesMeta: files.map(f => ({ name: f.name, size: f.size, type: f.type })),
        };
      }

      return { base, detail };
    }

    // æ—¥æœ¬å‘ã‘æ—¥æ™‚æ•´å½¢
    const z2 = n => String(n).padStart(2, '0');
    const toJP = (s) => {
      if (!s) return '';
      try {
        const d = new Date(s);
        return `${d.getFullYear()}/${z2(d.getMonth()+1)}/${z2(d.getDate())} ${z2(d.getHours())}:${z2(d.getMinutes())}`;
      } catch { return s; }
    };

    // é€ä¿¡ç”¨ã‚µãƒãƒªãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
    function buildLineText({ base, detail }) {
      const out = [];
      const push = (s='') => out.push(s);
      const t = base.requestType;

      const typeLabel = {
        image: 'ã‚¤ãƒ¡ãƒ¼ã‚¸',
        product: 'ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ',
        location: 'ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
        person: 'ãƒ‘ãƒ¼ã‚½ãƒ³',
      };

      if (t === 'card') {
        const cards = detail.cards || [];
        const label = typeLabel[cards[0]?.type || 'image'] || 'ã‚¤ãƒ¡ãƒ¼ã‚¸';
        push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
        push('ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸');
        push('ã€è¨­å®šå†…å®¹ã€‘');
        push(label);
        cards.forEach((c, i) => {
          push(`ãƒ»${i + 1}æšç›®`);
          push(`ã€€ç”»åƒæ ¼ç´ï¼šã€${c.hasImage ? 'æœ‰' : 'ç„¡'}ã€‘`);
          if (c.type === 'image') {
            if (c.tag) push(`ã€€ã‚¿ã‚°ï¼š${c.tag}`);
          }
          if (c.type === 'product') {
            if (c.tag) push(`ã€€ã‚¿ã‚°ï¼š${c.tag}`);
            if (c.meta?.title) push(`ã€€ã‚¿ã‚¤ãƒˆãƒ«ï¼š${c.meta.title}`);
            if (c.meta?.priceText) push(`ã€€ä¾¡æ ¼ï¼š${c.meta.priceText}`);
            if (c.meta?.desc) push(`ã€€èª¬æ˜ï¼š${c.meta.desc}`);
          }
          if (c.type === 'location') {
            if (c.tag) push(`ã€€ã‚¿ã‚°ï¼š${c.tag}`);
            if (c.meta?.title) push(`ã€€ã‚¿ã‚¤ãƒˆãƒ«ï¼š${c.meta.title}`);
            if (c.meta?.address) push(`ã€€ä½æ‰€ï¼š${c.meta.address}`);
            if (c.meta?.hours) push(`ã€€æ™‚é–“ï¼š${c.meta.hours}`);
            else if (c.meta?.priceText) push(`ã€€ä¾¡æ ¼ï¼š${c.meta.priceText}`);
          }
          if (c.type === 'person') {
            if (c.meta?.name) push(`ã€€åå‰ï¼š${c.meta.name}`);
            if (c.meta?.tags?.length) push(`ã€€ã‚¿ã‚°ï¼š${c.meta.tags.join(' / ')}`);
            if (c.meta?.desc) push(`ã€€èª¬æ˜ï¼š${c.meta.desc}`);
          }
          (c.actions || []).forEach((a, idx) => {
            push(`ã€€ãƒœã‚¿ãƒ³${idx + 1}ï¼š${a.label}`);
            push(`ã€€é·ç§»å…ˆï¼š${a.destination}`);
          });
        });
        return out.join('\n');
      }

      if (t === 'richmenu') {
        push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
        push('ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼');
        push('ã€è¨­å®šå†…å®¹ã€‘');
        (detail.richmenu?.buttons || []).forEach(b => {
          if (!(b.label && b.type && b.value)) return;
          push(`ãƒ»ãƒœã‚¿ãƒ³${b.index}`);
          push(`ã€€ãƒœã‚¿ãƒ³åï¼š${b.label}`);
          push(`ã€€é·ç§»å…ˆã‚¿ã‚¤ãƒ—ï¼š${b.type}`);
          push(`ã€€é·ç§»å…ˆå†…å®¹ï¼š${b.value}`);
        });
        return out.join('\n');
      }

      if (t === 'shopcard') {
        const sc = detail.shopcard || {};
        push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
        push('ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰');
        push('ã€è¨­å®šå†…å®¹ã€‘');
        push('ãƒ»åŸºæœ¬');
        if (sc.name) push(`ã€€ã‚«ãƒ¼ãƒ‰åï¼š${sc.name}`);
        push(`ã€€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼š${sc.color || '-'}`);
        push(`ã€€ç›®æ¨™ãƒã‚¤ãƒ³ãƒˆï¼š${Number.isFinite(sc.goalPoints) ? sc.goalPoints : '-'}pt`);
        if (sc.goalReward) push(`ã€€ã‚´ãƒ¼ãƒ«ç‰¹å…¸ï¼š${sc.goalReward}`);
        if (sc.checkpoint || sc.checkpointReward) {
          push(`ã€€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼š${sc.checkpoint || '-'}`);
          push(`ã€€ãƒã‚§ãƒƒã‚¯ç‰¹å…¸ï¼š${sc.checkpointReward || '-'}`);
        }
        push(`ã€€ç”»åƒæ ¼ç´ï¼šã€${sc.scImagePresent ? 'æœ‰' : 'ç„¡'}ã€‘`);

        push('ãƒ»ä»˜ä¸åˆ¶é™');
        if (sc.limit?.mode === 'hours') {
          push(`ã€€æŒ‡å®šæ™‚é–“å†…ã®é‡è¤‡ä»˜ä¸ã‚’ç¦æ­¢ï¼š${sc.limit.hours}æ™‚é–“`);
        } else if (sc.limit?.mode === 'sameDay') {
          push('ã€€åŒæ—¥ä¸­ã®é‡è¤‡ä»˜ä¸ã‚’ç¦æ­¢ï¼ˆ0:00ãƒªã‚»ãƒƒãƒˆï¼‰');
        } else {
          push('ã€€åˆ¶é™ãªã—');
        }

        push('ãƒ»æœ‰åŠ¹æœŸé™');
        if (sc.expire?.type === 'lastUse') {
          push(`ã€€æœ€çµ‚åˆ©ç”¨æ—¥ã‹ã‚‰ï¼š${sc.expire.lastUse?.years ?? 0}å¹´ ${sc.expire.lastUse?.months ?? 0}ãƒ¶æœˆ`);
        } else if (sc.expire?.type === 'firstUse') {
          push(`ã€€åˆå›åˆ©ç”¨æ—¥ã‹ã‚‰ï¼š${sc.expire.firstUse?.years ?? 0}å¹´ ${sc.expire.firstUse?.months ?? 0}ãƒ¶æœˆ`);
        } else {
          push('ã€€è¨­å®šã—ãªã„');
        }
        push(`ã€€é€šçŸ¥ï¼š${({ '1day':'å‰æ—¥', '3days':'3æ—¥å‰', '1week':'1é€±é–“å‰', 'none':'é€šçŸ¥ã—ãªã„' }[sc.notice] || '-')}`);

        push('ãƒ»ãã®ä»–');
        push(`ã€€ã‚«ãƒ¼ãƒ‰å–å¾—ãƒœãƒ¼ãƒŠã‚¹ï¼š${Number.isFinite(sc.bonus) ? sc.bonus : 0}pt`);
        if (sc.guide) push(`ã€€åˆ©ç”¨ã‚¬ã‚¤ãƒ‰ï¼š${sc.guide}`);
        return out.join('\n');
      }

      if (t === 'coupon') {
        const cp = detail.coupon || {};
        push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
        push('ã‚¯ãƒ¼ãƒãƒ³');
        push('ã€è¨­å®šå†…å®¹ã€‘');

        const period = () => {
          if (cp.type === 'referral') {
            const s = toJP(cp.period?.start);
            const e = toJP(cp.period?.end);
            if (s || e) push(`ã€€ç´¹ä»‹æœŸé–“ï¼š${s || '-'} ã€œ ${e || '-'}`);
          } else {
            const s = toJP(cp.start);
            const e = toJP(cp.end);
            if (s || e) push(`ã€€æœ‰åŠ¹æœŸé–“ï¼š${s || '-'} ã€œ ${e || '-'}`);
          }
        };

        if (cp.type === 'none') {
          push('ãƒ»æ¡ä»¶ãªã—');
          if (cp.name) push(`ã€€ã‚¯ãƒ¼ãƒãƒ³åï¼š${cp.name}`);
          if (cp.content) push(`ã€€å†…å®¹ï¼š${cp.content}`);
          period();
          if (cp.use) push(`ã€€ä½¿ç”¨ç”¨é€”ï¼š${cp.use}`);
          push(`ã€€ä½¿ç”¨å¯èƒ½å›æ•°ï¼š${cp.limit === 'unlimited' ? 'ä¸Šé™ãªã—' : '1å›ã®ã¿'}`);
          if (cp.condition) push(`ã€€åˆ©ç”¨æ¡ä»¶ï¼š${cp.condition}`);
          if (cp.guide) push(`ã€€åˆ©ç”¨ã‚¬ã‚¤ãƒ‰ï¼š${cp.guide}`);
          return out.join('\n');
        }

        if (cp.type === 'lottery') {
          push('ãƒ»æŠ½é¸');
          if (cp.name) push(`ã€€ã‚¯ãƒ¼ãƒãƒ³åï¼š${cp.name}`);
          if (cp.content) push(`ã€€å†…å®¹ï¼š${cp.content}`);
          period();
          push(`ã€€å½“é¸ç‡ï¼š${cp.rate ?? '-'}%`);
          push(`ã€€å½“é¸è€…ä¸Šé™ï¼š${cp.maxWinners ?? '-'}å`);
          if (cp.use) push(`ã€€ä½¿ç”¨ç”¨é€”ï¼š${cp.use}`);
          push(`ã€€ä½¿ç”¨å¯èƒ½å›æ•°ï¼š${cp.limit === 'unlimited' ? 'ä¸Šé™ãªã—' : '1å›ã®ã¿'}`);
          if (cp.condition) push(`ã€€åˆ©ç”¨æ¡ä»¶ï¼š${cp.condition}`);
          if (cp.guide) push(`ã€€åˆ©ç”¨ã‚¬ã‚¤ãƒ‰ï¼š${cp.guide}`);
          return out.join('\n');
        }

        if (cp.type === 'referral') {
          push('ãƒ»å‹ã ã¡ç´¹ä»‹');
          if (cp.name) push(`ã€€ã‚¯ãƒ¼ãƒãƒ³åï¼š${cp.name}`);
          period();
          if (cp.valid?.days) push(`ã€€ç²å¾—æ—¥ã‹ã‚‰ã®æœ‰åŠ¹æœŸé–“ï¼š${cp.valid.days}æ—¥`);
          const countText = cp.acquireCount?.type === 'custom'
            ? `${cp.acquireCount.value ?? '-'}å›`
            : 'ä¸Šé™ãªã—';
          push(`ã€€ç²å¾—å¯èƒ½å›æ•°ï¼š${countText}`);
          if (cp.content) push(`ã€€å†…å®¹ï¼š${cp.content}`);
          if (cp.use) push(`ã€€ä½¿ç”¨ç”¨é€”ï¼š${cp.use}`);
          if (cp.condition) push(`ã€€åˆ©ç”¨æ¡ä»¶ï¼š${cp.condition}`);
          if (cp.note) push(`ã€€æ³¨æ„äº‹é …ï¼š${cp.note}`);
          if (cp.guide) push(`ã€€åˆ©ç”¨ã‚¬ã‚¤ãƒ‰ï¼š${cp.guide}`);
          return out.join('\n');
        }

        push('ãƒ»è¨­å®šãŒæœªå®Œäº†ã§ã™');
        return out.join('\n');
      }

      if (t === 'other') {
        push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
        push('ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰');
        push('ã€è¨­å®šå†…å®¹ã€‘');
        if (detail.other?.text) push(`ã€€è‡ªç”±è¨˜è¿°ï¼š${detail.other.text}`);
        const n = detail.other?.imagesMeta?.length || 0;
        push(`ã€€ç”»åƒæšæ•°ï¼š${n}`);
        return out.join('\n');
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      push('ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘');
      push(t || '-');
      push('ã€è¨­å®šå†…å®¹ã€‘');
      push('è¨­å®šå†…å®¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return out.join('\n');
    }

    // ====== äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼†ã‚¬ãƒ¼ãƒ‰ï¼‰ ======
    let isSubmitting = false;
    function setLoading(v) {
      const ov = $('#loadingOverlay');
      if (!ov) return;
      ov.classList.toggle('active', !!v);
      ov.setAttribute('aria-hidden', v ? 'false' : 'true');
      // ä¸»è¦ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹åŒ–
      document.querySelectorAll('button').forEach(b => b.disabled = !!v);
    }

    // é€ä¿¡ï¼ˆGAS â†’ ãã®å¾Œ LINE é€ä¿¡ï¼‰
    async function submitForm() {
      if (isSubmitting) return; // äºŒé‡ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼ˆå³ãƒªã‚¿ãƒ¼ãƒ³ï¼‰

      const { base, detail } = collectData();

      // === å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆå…±é€šï¼‰ ===
      if (!base.storeName || !base.requestType) {
        alert('åº—èˆ—å ã¨ å¤§å…ƒã‚«ãƒ†ã‚´ãƒª ã¯å¿…é ˆã§ã™');
        return;
      }

      // === ã‚¿ã‚¤ãƒ—åˆ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ===
      if (base.requestType === 'card') {
        const cards = document.querySelectorAll('#cardsWrap .card');
        if (cards.length === 0) { alert('ã‚«ãƒ¼ãƒ‰æšæ•°ã‚’1ã€œ9ã§æŒ‡å®šã—ã¦ãã ã•ã„'); return; }
        if (cards.length > 9) { alert('ã‚«ãƒ¼ãƒ‰ã¯æœ€å¤§9æšã¾ã§ã§ã™'); return; }

        const cardType = ($('#cardGlobalType')?.value || 'image');
        for (let i = 0; i < cards.length; i++) {
          const card = cards[i];
          const img = card.querySelector('.cd-image');
          const files = img?.files || [];
          if (!files.length) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ç”»åƒã‚’1æšé¸æŠã—ã¦ãã ã•ã„`); return; }
          if (files.length > 1) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ç”»åƒã¯1æšã®ã¿é¸æŠã—ã¦ãã ã•ã„`); return; }

          if (cardType === 'product') {
            const title = card.querySelector('.pd-title')?.value.trim();
            if (!title) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå•†å“ï¼‰ã¯å¿…é ˆã§ã™`); return; }
          } else if (cardType === 'location') {
            const title = card.querySelector('.lc-title')?.value.trim();
            const hours = card.querySelector('.lc-hours')?.value.trim();
            const priceText = card.querySelector('.lc-priceText')?.value.trim();
            if (!title) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã¯å¿…é ˆã§ã™`); return; }
            if (hours && priceText) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ã€Œæ™‚é–“ã€ã¨ã€Œä¾¡æ ¼ã€ã¯ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„`); return; }
          } else if (cardType === 'person') {
            const name = card.querySelector('.ps-name')?.value.trim();
            if (!name) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: åå‰ï¼ˆäººç‰©ï¼‰ã¯å¿…é ˆã§ã™`); return; }
          }

          const btn1 = { label: (card.querySelector('.btn1-label')?.value || '').trim(), dest: (card.querySelector('.btn1-dest')?.value || '').trim() };
          const btns = (cardType === 'image')
            ? [btn1]
            : [btn1, { label: (card.querySelector('.btn2-label')?.value || '').trim(), dest: (card.querySelector('.btn2-dest')?.value || '').trim() }];

          for (let j = 0; j < btns.length; j++) {
            const b = btns[j];
            const any = !!(b.label || b.dest);
            if (any && (!b.label || !b.dest)) { alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³${j + 1}ã¯ã€Œãƒœã‚¿ãƒ³åã€ã¨ã€Œé·ç§»å…ˆã€ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„`); return; }
            if (b.dest && /^https?:\/\//i.test(b.dest) === false && b.dest.includes('http')) {
              alert(`ã‚«ãƒ¼ãƒ‰${i + 1}: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³${j + 1}ã®é·ç§»å…ˆãŒURLã‚‰ã—ã„ã§ã™ãŒ http(s):// ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„`);
              return;
            }
          }
        }
      }

      if (base.requestType === 'richmenu') {
        const btns = (detail.richmenu?.buttons || []);
        const invalid = btns.find(b => (b.label || b.type || b.value) && !(b.label && b.type && b.value));
        if (invalid) { alert(`ãƒœã‚¿ãƒ³${invalid.index}: ã€Œãƒœã‚¿ãƒ³åã€ã€Œé·ç§»å…ˆã‚¿ã‚¤ãƒ—ã€ã€Œé·ç§»å…ˆå†…å®¹ã€ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„`); return; }
      }

      if (base.requestType === 'coupon') {
        const cp = detail.coupon || {};
        if (!cp?.name) { alert('ã‚¯ãƒ¼ãƒãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      }

      if (base.requestType === 'other') {
        if (!detail.other?.text && (!$('#otherImages') || !$('#otherImages').files.length)) {
          alert('è‡ªç”±è¨˜è¿°ã¾ãŸã¯ç”»åƒã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
      }

      // ã“ã“ã‹ã‚‰é€ä¿¡å‡¦ç†ï¼ˆã‚¬ãƒ¼ãƒ‰ONï¼‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
      isSubmitting = true;
      setLoading(true);
      persistStoreName();

      // === é€ä¿¡ï¼ˆGASã«ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ / ç”»åƒã¯Base64ã§æ·»ä»˜ï¼‰ ===
      const fd = new FormData();
      fd.append('payload', JSON.stringify({ base, detail }));
      await appendFilesBase64(fd, '#cardsWrap', 'cardImage');
      await appendFilesBase64(fd, '#scImage', 'scImage');
      await appendFilesBase64(fd, '#otherImages', 'othImage');

      let lineOk = false;
      try {
        const res = await fetch(GAS_URL, { method: 'POST', body: fd });
        await res.text(); // æˆå¦ã®ã¿
        // === LINEã¸ã‚µãƒãƒªãƒ¼é€ä¿¡ï¼ˆLIFFå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰ ===
        const summary = buildLineText({ base, detail });
        lineOk = await trySendToLINE(summary);
      } catch (err) {
        setLoading(false);
        isSubmitting = false;
        alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message);
        return;
      }

      // é€ä¿¡å¾Œã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤–ã—ã¦ã‹ã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆ
      setLoading(false);
      isSubmitting = false;

      alert(lineOk
        ? 'é€ä¿¡ã—ã¾ã—ãŸï¼ˆGASä¿å­˜ï¼‹LINEã¸é€ä¿¡ï¼‰ã€‚ç”»é¢ã‚’é–‰ã˜ã¦ã‚‚OKã§ã™ã€‚'
        : 'é€ä¿¡ã—ã¾ã—ãŸï¼ˆGASä¿å­˜å®Œäº†ï¼‰ã€‚â€»LINEã‚¢ãƒ—ãƒªå¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã€LINEé€ä¿¡ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');

      try { if (lineOk) liff.closeWindow(); } catch {}
    }

    // ã€Œãã®ä»–ã€å°‚ç”¨é€ä¿¡
    on($('#btnSubmitOther'), 'click', () => {
      const sel = $('#requestType');
      if (sel && sel.value !== 'other') sel.value = 'other';
      Object.values(sections).forEach(s => show(s, false));
      show(sections.other, true);
      submitForm();
    });

    // ã‚«ãƒ©ãƒ¼é¸æŠ
    document.addEventListener('DOMContentLoaded', () => {
      const boxes = document.querySelectorAll('#colorSamples .color-box');
      const hidden = document.getElementById('scColor');

      boxes.forEach(box => {
        box.addEventListener('click', () => {
          boxes.forEach(b => b.classList.remove('selected'));
          box.classList.add('selected');
          hidden.value = box.dataset.color;
        });
      });
      document.querySelector('[data-color="#5a5aff"]')?.classList.add('selected');
    });

    // ã‚¯ãƒ¼ãƒãƒ³ã‚«ãƒ¼ãƒ‰åˆ‡æ›¿
    document.querySelectorAll('.coupon-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.coupon-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        const type = card.dataset.type;
        document.getElementById('cpAcquireType').value = type;
        document.querySelectorAll('.coupon-settings').forEach(s => s.style.display = 'none');
        document.getElementById(`cp-${type}-settings`).style.display = 'block';
      });
    });

    // å‹ã ã¡ç´¹ä»‹ã‚«ã‚¹ã‚¿ãƒ 
    const referralValidSelect = document.getElementById('cpReferralValidType');
    const referralCustomDays = document.getElementById('cpReferralCustomDays');
    if (referralValidSelect) referralValidSelect.addEventListener('change', () => {
      referralCustomDays.style.display = referralValidSelect.value === 'custom' ? 'block' : 'none';
    });
    const referralCountType = document.getElementById('cpReferralCountType');
    const referralCountCustom = document.getElementById('cpReferralCountCustom');
    if (referralCountType) referralCountType.addEventListener('change', () => {
      referralCountCustom.style.display = referralCountType.value === 'custom' ? 'block' : 'none';
    });

    // ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼šãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ
    function initRichmenuHotspots() {
      const wrap = document.getElementById('rmMapWrap');
      const img = document.getElementById('rmMapImg');
      if (!wrap || !img) return;

      const grid = [
        { area: 'A', btn: 1, col: 0, row: 0 },
        { area: 'B', btn: 2, col: 1, row: 0 },
        { area: 'C', btn: 3, col: 2, row: 0 },
        { area: 'D', btn: 4, col: 0, row: 1 },
        { area: 'E', btn: 5, col: 1, row: 1 },
        { area: 'F', btn: 6, col: 2, row: 1 },
      ];

      const renderHotspots = () => {
        const wrapRect = wrap.getBoundingClientRect();
        const imgRect  = img.getBoundingClientRect();
        const imgW = imgRect.width;
        const imgH = imgRect.height;
        if (!imgW || !imgH) return;

        const offsetX = imgRect.left - wrapRect.left;
        const offsetY = imgRect.top  - wrapRect.top;

        const cellW = imgW / 3;
        const cellH = imgH / 2;

        wrap.querySelectorAll('.rm-hot').forEach(el => el.remove());

        grid.forEach(g => {
          const d = document.createElement('div');
          d.className = 'rm-hot';
          d.dataset.btn = g.btn;
          d.style.left   = `${offsetX + g.col * cellW}px`;
          d.style.top    = `${offsetY + g.row * cellH}px`;
          d.style.width  = `${cellW}px`;
          d.style.height = `${cellH}px`;
          d.addEventListener('click', () => highlightAndScroll(g.btn));
          wrap.appendChild(d);
        });
      };

      if (img.complete) renderHotspots();
      else img.addEventListener('load', renderHotspots);
      window.addEventListener('resize', renderHotspots);
    }

    function highlightAndScroll(btnIndex) {
      const card = document.getElementById('rmBtn' + btnIndex);
      const hotspot = document.querySelector(`.rm-hot[data-btn="${btnIndex}"]`);
      if (!card || !hotspot) return;
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      hotspot.classList.add('active');
      setTimeout(() => hotspot.classList.remove('active'), 1200);
    }

    window.addEventListener('load', () => {
      initRichmenuHotspots();
      wireInputFocusToHighlight();
    });

    function wireInputFocusToHighlight() {
      for (let i = 1; i <= 6; i++) {
        const card = document.getElementById('rmBtn' + i);
        if (!card) continue;
        card.querySelectorAll('input,select,textarea').forEach(el => {
          el.addEventListener('focus', () => { });
          el.addEventListener('blur', () => { });
        });
      }
    }

    // å„ã‚«ãƒ†ã‚´ãƒªã®ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œï¼ˆè¡¨ç¤ºä¸­ã®ã¿è¿½åŠ ï¼‰
    function ensureLocalActions(sectionEl) {
      if (!sectionEl || sectionEl.querySelector('.local-actions')) return;
      if (sectionEl.id === 'sec-other') return; // ãã®ä»–ã¯å°‚ç”¨ãƒœã‚¿ãƒ³ã‚ã‚Š
      const actions = document.createElement('div');
      actions.className = 'local-actions';
      actions.innerHTML = `
        <button type="button" class="primary btnSubmitLocal">ã“ã®å†…å®¹ã§é€ä¿¡</button>
        <span class="tip">â€»ä¸Šéƒ¨ã®å¿…é ˆé …ç›®ã‚‚ã”ç¢ºèªãã ã•ã„</span>
      `;
      sectionEl.appendChild(actions);
      actions.querySelector('.btnSubmitLocal').addEventListener('click', submitForm, { passive: true });
    }

    // ã‚«ãƒ¼ãƒ‰è¦‹ãŸç›®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•åæ˜ ï¼‰
    function updateCardPreview() {
      const wrap = document.querySelector("#cardSampleContainer");
      const cards = document.querySelectorAll("#cardsWrap .card");
      wrap.innerHTML = "";
      if (!cards.length) {
        document.querySelector("#cardSampleWrap").style.display = "none";
        return;
      }
      document.querySelector("#cardSampleWrap").style.display = "";

      cards.forEach((card, idx) => {
        const type = card.dataset.type || "product";
        const tag = card.querySelector(".img-tag, .pd-tag, .lc-tag")?.value?.trim() || "";
        const title = card.querySelector(".pd-title, .lc-title, .ps-name")?.value?.trim() || "";
        const address = card.querySelector(".lc-address")?.value?.trim() || "";
        const desc = card.querySelector(".pd-desc, .ps-desc")?.value?.trim() || "";
        const hours = card.querySelector(".lc-hours")?.value?.trim() || "";
        const priceText = card.querySelector(".pd-priceText, .lc-priceText")?.value?.trim() || "";
        const b1 = card.querySelector(".btn1-label")?.value?.trim() || "";

        let imgSrc = "data:image/svg+xml;base64," + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="240"><rect width="400" height="240" fill="#eaeaea"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#999">No Image</text></svg>');

        const cardEl = document.createElement("div");
        cardEl.className = "sample-card";
        cardEl.id = `sampleCard${idx}`;

        let innerHTML = "";
        switch (type) {
          case "location":
            innerHTML = `
              <img src="${imgSrc}" alt="">
              <div class="sample-body">
                ${tag ? `<div class="tag">${tag}</div>` : ""}
                <div class="title">${title || "ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"}</div>
                <div class="desc">
                  <div>ğŸ“ ${address || "ä½æ‰€ã‚’å…¥åŠ›"}</div>
                  <div>ğŸ•’ ${hours || ""}</div>
                </div>
                ${priceText ? `<div class="price">${priceText}</div>` : ""}
              </div>
              ${b1 ? `<div class="buttons"><div class="btn">${b1}</div></div>` : ""}
            `;
            break;
          case "person":
            innerHTML = `
              <img src="${imgSrc}" alt="">
              <div class="sample-body">
                <div class="title">${title || "åå‰ã‚’å…¥åŠ›"}</div>
                ${tag ? `<div class="tag">${tag}</div>` : ""}
                <div class="desc">${desc || ""}</div>
              </div>
              ${b1 ? `<div class="buttons"><div class="btn">${b1}</div></div>` : ""}
            `;
            break;
          case "image":
            innerHTML = `
              <img src="${imgSrc}" alt="">
              <div class="sample-body">
                ${tag ? `<div class="tag">${tag}</div>` : ""}
              </div>
              ${b1 ? `<div class="buttons"><div class="btn">${b1}</div></div>` : ""}
            `;
            break;
          default:
            innerHTML = `
              <img src="${imgSrc}" alt="">
              <div class="sample-body">
                ${tag ? `<div class="tag">${tag}</div>` : ""}
                <div class="title">${title || "ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"}</div>
                <div class="desc">${desc || ""}</div>
                ${priceText ? `<div class="price">${priceText}</div>` : ""}
              </div>
              ${b1 ? `<div class="buttons"><div class="btn">${b1}</div></div>` : ""}
            `;
        }

        cardEl.innerHTML = innerHTML;
        wrap.appendChild(cardEl);

        const file = card.querySelector(".cd-image")?.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => { cardEl.querySelector("img").src = e.target.result; };
          reader.readAsDataURL(file);
        }
      });
    }

    // å…¥åŠ›å¤‰åŒ–ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆã‚«ãƒ¼ãƒ‰å†…ï¼‰
    document.addEventListener("change", (e) => {
      if (e.target.closest("#cardsWrap")) updateCardPreview();
      if (e.target.id === 'cardGlobalType' || e.target.id === 'cardCount') setTimeout(updateCardPreview, 200);
    });
    document.addEventListener("input", (e) => {
      if (e.target.closest("#cardsWrap")) updateCardPreview();
    });
  </script>
</body>
</html>
